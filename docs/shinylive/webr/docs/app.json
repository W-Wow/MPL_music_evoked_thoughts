[{"name":"app.R","content":"# \r\n# 2025/11/01 WW\r\n# shinylive::export(appdir = \"../music_evoked_thought/\", destdir = \"docs\")\r\n# httpuv::runStaticServer(\"docs/\", port = 8008)\r\n#\r\n# Load packages ---------------------------\r\n\r\nlibrary(shiny)\r\nlibrary(ggplot2)\r\nlibrary(tidyverse)\r\nlibrary(tidyr)\r\nlibrary(dplyr)\r\nlibrary(plotly)\r\nlibrary(htmltools)\r\nlibrary(bslib)\r\nlibrary(munsell)\r\n\r\n\r\n# Load data ---------------------------\r\n\r\nall_data_csv <- \r\n  \"https://raw.githubusercontent.com/W-Wow/MPL_music_evoked_thoughts/refs/heads/main/MEIstudy1_Raw_data_cleaned_final_sharing_with_songs_havethoughts_online.csv\"\r\ndf <- readr::read_csv(all_data_csv)\r\nvarSelect <- df |> select(starts_with('dimension_'))\r\nvarSelect_1 <- df |> select(starts_with('excerpt_name_ori'))\r\n\r\n# Define ui ---------------------------\r\n\r\nui <- fluidPage(\r\n  titlePanel(\"Interactive MPL music-evoked thoughts Player!\"),\r\n  theme = bs_theme(preset = \"vapor\"),\r\n  \r\n  sidebarLayout(\r\n    sidebarPanel(        \r\n      HTML('<p class=\"text-secondary\">Click on points to play associated audio<\/p>'),\r\n      uiOutput(\"audio_player_ui\"),\r\n      verbatimTextOutput(\"selected_info\"),\r\n      \r\n      selectInput(inputId = \"Excerpt_name\",\r\n                  label = \"Enter excerpt:\",\r\n                  choices = c(\"All music\", unique(df$excerpt_name_original))),     \r\n      selectInput(\"xvar\", \"X variable\", names(varSelect), selected = \"dimension_of_similarity_1\"),\r\n      selectInput(\"yvar\", \"Y variable\", names(varSelect), selected = \"dimension_of_similarity_2\"),\r\n      checkboxGroupInput(\r\n        \"Genre\", \"Filter by genre\",\r\n        choices = unique(df$genre_code), \r\n        selected = unique(df$genre_code)\r\n      ),\r\n      \r\n      checkboxGroupInput(\r\n        \"Age_group\", \"Filter by age group\",\r\n        choices = unique(df$age_group), \r\n        selected = unique(df$age_group)\r\n      ),\r\n      \r\n      tags$head(\r\n        tags$style(HTML(\"\r\n      .genre-legend {\r\n        display: flex;\r\n        flex-wrap: wrap;\r\n        justify-content: center;\r\n        gap: 10px;\r\n        margin-top: 10px;\r\n        padding: 10px;\r\n        background-color: white;\r\n        border-radius: 5px;\r\n      }\r\n      .genre-item {\r\n        display: flex;\r\n        align-items: center;\r\n        gap: 5px;\r\n        font-size: 14px;\r\n        color: black;\r\n      }\r\n      .genre-color {\r\n        width: 15px;\r\n        height: 15px;\r\n        border-radius: 50%;\r\n      }\r\n      .age_group-legend {\r\n        display: flex;\r\n        flex-wrap: wrap;\r\n        justify-content: center;\r\n        gap: 10px;\r\n        margin-top: 10px;\r\n        padding: 10px;\r\n        background-color: white;\r\n        border-radius: 5px;\r\n      }\r\n      .age_group-item {\r\n        display: flex;\r\n        align-items: center;\r\n        gap: 5px;\r\n        font-size: 14px;\r\n        color: black;\r\n      }\r\n      .age_group-symbol {\r\n        width: 14px;\r\n        height: 27px;\r\n        border-radius: 50%;\r\n        font-size: 18px;\r\n      }\r\n    \"))\r\n      ),\r\n      \r\n      hr(), \r\n      checkboxInput(\"by_genre\", \"Show genres\", TRUE),\r\n      checkboxInput(\"by_age_group\", \"Show age groups\", TRUE)\r\n    ),\r\n    mainPanel(\r\n      plotlyOutput(\"scatterplot\", height = \"700px\"),\r\n      uiOutput(\"genre_legend\"),\r\n      uiOutput(\"age_group_legend\")\r\n    )\r\n  ),\r\n  \r\n  tags$script(HTML(\"\r\n    Shiny.addCustomMessageHandler('resetValue', function(e, data) {\r\n      Shiny.onInputChange('clicked_point_index', null);\r\n    });\r\n  \")),\r\n  \r\n  tags$script(HTML(\"\r\n    $(document).on('plotly_click', function(e, data) {\r\n      \r\n      // Update selected point in Shiny\r\n      Shiny.setInputValue('clicked_point_index', null);\r\n    });\r\n  \")),\r\n  \r\n  # add JavaScript for handling clicks\r\n  tags$script(HTML(\"\r\n    $(document).on('plotly_click', function(e, data) {\r\n      var pointNumber = data.points[0].pointNumber;\r\n      var audioFile = data.points[0].customdata;\r\n      \r\n      // Update selected point in Shiny\r\n      Shiny.setInputValue('clicked_point_index', pointNumber);\r\n    });\r\n  \"))\r\n  \r\n)\r\n\r\n\r\n# Define server ---------------------------\r\n\r\nserver <- function(input, output, session) {\r\n  \r\n  genre_colors <- c(\r\n    \"60s pop\" = \"#e6e600\", \"80s pop\" = \"#008000\", \"Ambient\" = \"#20a2f2\", \"Classical\" = \"#e6ccff\", \r\n    \"Electronic\" = \"#00e673\", \r\n    \"Film\" = \"#681fc3\", \"Funk\" = \"#86592d\", \r\n    \"Jazz\" = \"#ffbd31\", \"Metal\" = \"#999999\", \"Pop\" = \"#ff4d88\")\r\n  \r\n  age_group_shapes <- c(\r\n    \"Age18to30\" = \"circle\", \"Age31to45\" = \"triangle-up\", \"Age46to60\" = \"square\", \"Age61to75\" = \"cross\")\r\n  \r\n  age_group_shapes_legend <- c(\r\n    \"Age18to30\" = \"â¬¤\", \"Age31to45\" = \"â–²\", \"Age46to60\" = \"â– \", \"Age61to75\" = \"+\")\r\n  \r\n  changed_filter_mark <- reactiveValues(count = 0)\r\n  \r\n  subsetted <- reactive({\r\n    req(input$Genre, input$Age_group)\r\n    \r\n    if (input$Excerpt_name==\"All music\"){\r\n      df |> filter(genre_code %in% input$Genre & age_group %in% input$Age_group)\r\n    }\r\n    else {df |> filter(genre_code %in% input$Genre & age_group %in% input$Age_group & excerpt_name_original %in% input$Excerpt_name)}\r\n  })\r\n  \r\n  ### stop auto play when changing filter conditions _w\r\n  \r\n  observeEvent(input$Excerpt_name,{\r\n    changed_filter_mark$count <- 2\r\n  }) \r\n  \r\n  observeEvent(input$Genre,{\r\n    changed_filter_mark$count <- 2\r\n  })\r\n  \r\n  observeEvent(input$Age_group,{\r\n    changed_filter_mark$count <- 2\r\n  })\r\n  \r\n  observeEvent(input$by_genre,{\r\n    changed_filter_mark$count <- 2\r\n  })\r\n  \r\n  observeEvent(input$by_age_group,{\r\n    changed_filter_mark$count <- 2\r\n  })\r\n  \r\n  observeEvent(input$clicked_point_index,{\r\n    changed_filter_mark$count <- 1\r\n  })\r\n  \r\n  \r\n  data <- reactive({\r\n    req(input$xvar, input$yvar)\r\n    \r\n    data.frame(\r\n      id = subsetted()$audio_name,\r\n      x = subsetted()[[input$xvar]],  # dynamic x variable\r\n      y = subsetted()[[input$yvar]],  # dynamic y variable\r\n      audio_file = paste0(\r\n        \"https://raw.githubusercontent.com/W-Wow/MPL_music_evoked_thoughts/refs/heads/main/Excerpt_final_set/\", \r\n        subsetted()$audio_name),\r\n      description = subsetted()$have_thought_input.text_EDIT,\r\n      genre_code = subsetted()$genre_code,\r\n      age_group = subsetted()$age_group\r\n    )\r\n  }\r\n  )\r\n  \r\n  # Create the interactive plotly scatterplot\r\n  output$scatterplot <- renderPlotly({\r\n    plot_data <- data()\r\n    \r\n    if (input$by_genre) {\r\n      plot_data$color <- genre_colors[plot_data$genre_code]\r\n      \r\n    } else {\r\n      plot_data$color <- \"#472b81\"\r\n      \r\n    }\r\n    \r\n    if (input$by_age_group) {\r\n      plot_data$symbol <- age_group_shapes[plot_data$age_group]\r\n    } else {\r\n      plot_data$symbol <- \"diamond\"\r\n    }\r\n    \r\n    # Create the plotly scatter plot\r\n    p <- plot_ly(plot_data, \r\n                 x = ~x, \r\n                 y = ~y,\r\n                 type = \"scatter\",\r\n                 mode = \"markers\",\r\n                 marker = list(\r\n                   size = 12,\r\n                   color = ~color,\r\n                   symbol= ~symbol,\r\n                   opacity = 0.7\r\n                 ), \r\n                 text = ~description,\r\n                 customdata = ~audio_file,\r\n                 hoverinfo = \"text\") %>%\r\n      \r\n      layout(\r\n        xaxis = list(\r\n          title = list(text = input$xvar, font = list(size = 14)),\r\n          zeroline = TRUE,\r\n          showgrid = TRUE,\r\n          gridcolor = \"#E2E2E2\",\r\n          showline = TRUE,\r\n          linecolor = \"#000000\",\r\n          tickfont = list(size = 12),\r\n          range = c(-83,83)  # added axes padding min(plot_data$x) - 0.5, max(plot_data$x) + 0.5\r\n        ),\r\n        yaxis = list(\r\n          title = list(text = input$yvar, font = list(size = 14)),\r\n          zeroline = TRUE,\r\n          showgrid = TRUE,\r\n          gridcolor = \"#E2E2E2\",\r\n          showline = TRUE,\r\n          linecolor = \"#000000\",\r\n          tickfont = list(size = 12),\r\n          range = c(-83,83)  # added axes padding min(plot_data$y) - 0.5, max(plot_data$y) + 0.5\r\n        ),\r\n        \r\n        hoverlabel = list(\r\n          bgcolor = \"white\",\r\n          font = list(size = 12, color = \"black\")\r\n        ),\r\n        margin = list(l = 50, r = 50, b = 50, t = 50, pad = 4)\r\n      )\r\n    return(p)\r\n  })\r\n  \r\n  # Create manual legend\r\n  output$genre_legend <- renderUI({\r\n    req(input$by_genre)\r\n    \r\n    genre_items <- lapply(input$Genre, function(func_genre) {\r\n      tags$div(\r\n        class = \"genre-item\",\r\n        tags$div(\r\n          class = \"genre-color\", \r\n          style = paste0(\"background-color: \", genre_colors[func_genre], \";\")\r\n        ),\r\n        tags$span(func_genre)\r\n      )\r\n    })\r\n    \r\n    tags$div(\r\n      class = \"genre-legend\",\r\n      genre_items\r\n    )\r\n  })\r\n  \r\n  output$age_group_legend <- renderUI({\r\n    req(input$by_age_group)\r\n    \r\n    age_group_items <- lapply(input$Age_group, function(func_age_group) {\r\n      tags$div(\r\n        class = \"age_group-item\",\r\n        tags$div(\r\n          class = \"age_group-symbol\",\r\n          age_group_shapes_legend[func_age_group]\r\n          #style = paste0(\"background-color: #b11226;\") # \"â¬¤ â–² â–  ðŸž¤\"\r\n        ),\r\n        tags$span(func_age_group)\r\n      )\r\n    })\r\n    \r\n    tags$div(\r\n      class = \"age_group-legend\",\r\n      age_group_items\r\n    )\r\n  })\r\n  \r\n  # React to clicked point and get the associated data\r\n  selectedPoint <- reactive({\r\n    req(input$clicked_point_index)\r\n    index <- input$clicked_point_index + 1\r\n    point <- data()[index, ]\r\n    return(point)\r\n  })\r\n  \r\n  # Display selected point info\r\n  output$selected_info <- renderText({\r\n    if (is.null(input$clicked_point_index)) {\r\n      return(\"No point selected yet. Click a point to play its audio.\")\r\n    } else if (changed_filter_mark$count == 1) {\r\n      point <- selectedPoint()\r\n      paste0(\r\n        \"Selected Point:\\n\",\r\n        \"Music: \", point$id, \"\\n\",\r\n        \"X: \", round(point$x, 3), \"\\n\",\r\n        \"Y: \", round(point$y, 3), \"\\n\",\r\n        \"Thought: \", point$description\r\n      )\r\n    }\r\n  })\r\n  \r\n  # Generate audio player for selected point\r\n  output$audio_player_ui <- renderUI({\r\n    if (is.null(input$clicked_point_index)) {\r\n      return(NULL)\r\n    }\r\n    else if (changed_filter_mark$count == 1){\r\n      point <- selectedPoint()\r\n      tags$div(\r\n        tags$p(paste(\"Playing audio for point:\", point$id)),\r\n        tags$audio(src = point$audio_file, type = \"audio/mp3\", controls = TRUE, autoplay = TRUE)\r\n      )\r\n    }\r\n  })\r\n  \r\n}\r\n\r\n# Create & run Shiny app ---------------------------\r\n\r\nshinyApp(ui = ui, server = server)   \r\n\r\n","type":"text"},{"name":"music_evoked_thought.Rproj","content":"Version: 1.0\r\n\r\nRestoreWorkspace: Default\r\nSaveWorkspace: Default\r\nAlwaysSaveHistory: Default\r\n\r\nEnableCodeIndexing: Yes\r\nUseSpacesForTab: Yes\r\nNumSpacesForTab: 2\r\nEncoding: UTF-8\r\n\r\nRnwWeave: Sweave\r\nLaTeX: pdfLaTeX\r\n","type":"text"}]
